## ğŸ“˜ é¡¹ç›®èƒŒæ™¯ä¸åœºæ™¯

å¤§æ–‡ä»¶ä¸Šä¼ åœ¨å®é™…ä¸šåŠ¡ä¸­æ˜¯é«˜é¢‘éœ€æ±‚ï¼Œå¸¸è§åº”ç”¨åœºæ™¯ï¼š

- è§†é¢‘ã€å›¾åƒèµ„æ–™ä¸Šä¼ ï¼ˆå¦‚ CMSã€è§†é¢‘å¹³å°ï¼‰
- æ—¥å¿—ã€æŠ¥è¡¨å¯¼å…¥ç­‰æ‰¹é‡æ–‡ä»¶å¤„ç†
- ç½‘ç»œç¯å¢ƒä¸ç¨³å®šåœºæ™¯ï¼ˆéœ€æ–­ç‚¹ç»­ä¼ ï¼‰

---

## ğŸ§© åŠŸèƒ½æ¨¡å—æ‹†è§£

1. æ–‡ä»¶åˆ†ç‰‡ï¼ˆsliceFileï¼‰
2. æ–‡ä»¶å“ˆå¸Œï¼ˆgetFileHashï¼‰å®ç°ç§’ä¼ æ ¡éªŒ
3. æ–‡ä»¶ä¸Šä¼  + åˆå¹¶
4. è¿›åº¦æ¡
5. å¤±è´¥é‡è¯•æœºåˆ¶
6. æ–­ç‚¹ç»­ä¼ ï¼ˆæ”¯æŒæœåŠ¡å™¨è®°å½•å·²ä¸Šä¼ åˆ†ç‰‡ï¼‰

---

## ğŸ› ï¸ é€šç”¨å·¥å…·å‡½æ•°

### 1. åˆ†ç‰‡å·¥å…·

```ts
export function sliceFile(file: File, size = 5 * 1024 * 1024) {
  const chunks: Blob[] = [];
  let start = 0;
  while (start < file.size) {
    const end = Math.min(file.size, start + size);
    chunks.push(file.slice(start, end));
    start = end;
  }
  return chunks;
}
```

### 2. è·å–æ–‡ä»¶ Hash

```ts
import SparkMD5 from "spark-md5";

export async function getFileHash(file: File): Promise<string> {
  return new Promise((resolve) => {
    const spark = new SparkMD5.ArrayBuffer();
    const chunkSize = 2 * 1024 * 1024;
    const chunks = sliceFile(file, chunkSize);
    const reader = new FileReader();
    let index = 0;

    reader.onload = (e) => {
      spark.append(e.target?.result as ArrayBuffer);
      index++;
      if (index < chunks.length) {
        reader.readAsArrayBuffer(chunks[index]);
      } else {
        resolve(spark.end());
      }
    };

    reader.readAsArrayBuffer(chunks[index]);
  });
}
```

---

## ğŸŸ¢ Vue ç‰ˆæœ¬å®ç°

```vue
<template>
  <input type="file" @change="onFileChange" />
</template>

<script lang="ts" setup>
import axios from "axios";
import { sliceFile, getFileHash } from "./utils";

const onFileChange = async (e: Event) => {
  const target = e.target as HTMLInputElement;
  const file = target.files?.[0];
  if (!file) return;

  const hash = await getFileHash(file);
  const { data } = await axios.post("/api/upload/check", { hash });
  if (data.exists) {
    console.log("æ–‡ä»¶å·²å­˜åœ¨");
    return;
  }

  const chunks = sliceFile(file);
  const uploadedList = data.uploadedList || [];

  for (let i = 0; i < chunks.length; i++) {
    if (uploadedList.includes(i)) continue;

    const formData = new FormData();
    formData.append("file", chunks[i]);
    formData.append("hash", hash);
    formData.append("index", i.toString());

    let retry = 0;
    while (retry < 3) {
      try {
        await axios.post("/api/upload/chunk", formData, {
          onUploadProgress: (e) => {
            const percent = ((i + e.loaded / e.total!) / chunks.length) * 100;
            console.log(`ä¸Šä¼ è¿›åº¦ï¼š${percent.toFixed(2)}%`);
          },
        });
        break;
      } catch (err) {
        retry++;
        if (retry === 3) throw err;
      }
    }
  }

  await axios.post("/api/upload/merge", { hash, chunkTotal: chunks.length });
  console.log("ä¸Šä¼ å®Œæˆ âœ…");
};
</script>
```

---

## ğŸ”µ React ç‰ˆæœ¬å®ç°

```tsx
import React from "react";
import axios from "axios";
import { sliceFile, getFileHash } from "./utils";

const FileUploader: React.FC = () => {
  const handleChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const hash = await getFileHash(file);
    const { data } = await axios.post("/api/upload/check", { hash });
    if (data.exists) {
      console.log("æ–‡ä»¶å·²å­˜åœ¨");
      return;
    }

    const chunks = sliceFile(file);
    const uploadedList = data.uploadedList || [];

    for (let i = 0; i < chunks.length; i++) {
      if (uploadedList.includes(i)) continue;

      const formData = new FormData();
      formData.append("file", chunks[i]);
      formData.append("hash", hash);
      formData.append("index", i.toString());

      let retry = 0;
      while (retry < 3) {
        try {
          await axios.post("/api/upload/chunk", formData, {
            onUploadProgress: (e) => {
              const percent = ((i + e.loaded / e.total!) / chunks.length) * 100;
              console.log(`ä¸Šä¼ è¿›åº¦ï¼š${percent.toFixed(2)}%`);
            },
          });
          break;
        } catch (err) {
          retry++;
          if (retry === 3) throw err;
        }
      }
    }

    await axios.post("/api/upload/merge", { hash, chunkTotal: chunks.length });
    console.log("ä¸Šä¼ å®Œæˆ âœ…");
  };

  return <input type="file" onChange={handleChange} />;
};

export default FileUploader;
```

---

## ğŸ“¡ åç«¯æ¥å£è®¾è®¡

- `POST /api/upload/check`ï¼šæ ¡éªŒæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè¿”å›å·²ä¸Šä¼ åˆ†ç‰‡åˆ—è¡¨
- `POST /api/upload/chunk`ï¼šä¸Šä¼ ä¸€ä¸ªåˆ†ç‰‡
- `POST /api/upload/merge`ï¼šé€šçŸ¥åˆå¹¶å…¨éƒ¨åˆ†ç‰‡

---

## âœ… ä¼˜åŒ–ç‚¹æ‹“å±•

- æ”¯æŒ Web Worker è®¡ç®— hash
- ä½¿ç”¨æ–­ç‚¹ç»­ä¼ ç­–ç•¥è®°å½•ä¸Šä¼ çŠ¶æ€
- å¢åŠ  UI è¿›åº¦æ¡å±•ç¤ºï¼ˆelement-plusã€antdï¼‰
- é™åˆ¶å¹¶å‘åˆ†ç‰‡ä¸Šä¼ ï¼Œä½¿ç”¨ Promise pool

---
